
@using GSLogistics.Website.Admin.Models
@using GSLogistics.Website.Common

@model  OrderAppointmentsIndex_ViewModel


@{
    ViewBag.Title = "List";
    AjaxOptions ajaxOptions = new AjaxOptions { UpdateTargetId = "panelBody", LoadingElementId = "loading", LoadingElementDuration = 1000 };

}
@{
    var customers = this.ViewBag.Customers as SelectList;
    var divisions = this.ViewBag.Divisions as SelectList;
    var scacCodes = this.ViewBag.ScacCodes as SelectList;
    var appointmentStatus = this.ViewBag.AppointmentStatus as SelectList;
}
<div class="row">
    <ul class="nav nav-pills nav-justified">
        <li class="active" role="presentation"><a data-toggle="pill" href="#orders"><h3>Orders</h3></a></li>
        <li role="presentation"><a data-toggle="pill" href="#appointments"><h3>Appointments</h3></a></li>
    </ul>
</div>

<div class="tab-content">
    <div id="orders" class="tab-pane fade in active">

        @*<h2>Orders</h2>*@
        @using (Html.BeginForm())
        {
            <div class="row">
                <div class="btn-group btn-group-justified">

                    @if (User.IsInRole("Administrators"))
                    {
                        <a href="#" class="btn btn-info" onclick="setAppointment()">Set Appointment</a>
                        <a href="#" class="btn btn-info" onclick="showConfirmationNumberModal()">Set Confirmation #</a>
                        <a href="#" class="btn btn-info" id="btnReport">Download Report</a>
                    }
                    <a href="#" class="btn btn-info" id="btnRefresh">Refresh</a>

                </div>
                <div class="panel panel-default">
                    <div class="panel-heading">Search</div>
                    <div class="panel-body">
                        @if (customers.Count() > 0)
                        {
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        @Html.LabelFor(model => model.SelectedClientId)
                                        @Html.DropDownListFor(m => m.SelectedClientId, customers, "Select", new { @class = "form-control" })
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        @Html.LabelFor(model => model.SelectedDivisionId)
                                        @Html.DropDownListFor(m => m.SelectedDivisionId, divisions, "Select", new { @class = "form-control" })
                                    </div>
                                </div>
                            </div>
                        }
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    @Html.LabelFor(model => model.CancelDateStartDate)
                                    @Html.DatePicker(x => x.CancelDateStartDate, 0, new { @class = "form-control" })
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    @Html.LabelFor(model => model.CancelDateEndDate)
                                    @Html.DatePicker(x => x.CancelDateEndDate,0, new { @class = "form-control" })
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    @*<input type="checkbox" id="chkShipForSearch" />*@

                                    @Html.CheckBoxFor(m => m.EnableShipForFilter, new { @id = "chkShipForSearch" })
                                    @Html.LabelFor(model => model.ShipFor)
                                    @if (!Model.EnableShipForFilter)
                                    {
                                        @Html.DatePicker(x => x.ShipFor, 0, new { @class = "form-control", @disabled = "disabled" })
                                    }
                                    else
                                    {
                                        @Html.DatePicker(x => x.ShipFor,0, new { @class = "form-control" })
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
        <div class="row">
            <div class="panel panel-default" id="selectedPanel">
                <div class="panel-heading">
                    Selected Orders For Appointment
                </div>
                <div class="panel panel-body">
                    <table class="table table-hover" id="tableSelectedOrders">
                        <thead>
                            <tr>
                                <th>Ship To</th>
                                <th>Start Date</th>
                                <th>Cancel Date</th>
                                <th>PO#</th>
                                <th>PT#</th>
                                <th>Pcs</th>
                                <th>Lbs</th>
                                <th>Ctns.</th>
                                <th>Cubic</th>
                                <th>Ctn Size</th>
                                <th>Bol</th>
                                <th style="display:none">DeliveryType</th>
                                <th style="display:none">ScacCode</th>
                                <th>ShipFor</th>
                            </tr>
                        </thead>
                        
                    </table>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="panel panel-default">
                <div class="panel-heading">
                    Orders for Appointment
                </div>

                <div class="panel-body">
                    <div class="row">
                        <div class="col-md-12">
                            <table class="table display-compact table-bordered table-striped" id="tableAppointments" cellspacing="0" width="100%">
                                <tfoot>
                                    <tr>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                        <th>PO#</th>
                                        <th>PT#</th>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                        <th></th>
                                        <th style="visibility:hidden"></th>
                                        <th style="visibility:hidden"></th>
                                        <th style="visibility:hidden"></th>
                                        <th></th>
                                        <th></th>
                                        <th style="visibility:hidden"></th>
                                        <th style="visibility:hidden"></th>
                                        <th style="visibility:hidden"></th>
                                        <th style="visibility:hidden"></th>
                                        <th style="visibility:hidden"></th>
                                        <th></th>
                                    </tr>
                                </tfoot>
                                <thead>
                                    <tr>
                                        <th class="text-center">

                                        </th>
                                        <th>
                                            @*@Html.DisplayNameFor(model => model.StoreName)*@
                                            Ship To
                                        </th>
                                        <th>
                                            Start Date
                                        </th>
                                        <th>Cancel Date</th>
                                        <th>PO#</th>
                                        <th>PT#</th>
                                        <th>
                                            Pcs
                                            @*@Html.DisplayNameFor(model => model.Pieces)*@
                                        </th>
                                        <th>
                                            Lbs@*@Html.DisplayNameFor(model => model.Weight)*@
                                        </th>
                                        <th>
                                            Ctns.
                                            @*@Html.DisplayNameFor(model => model.BoxesNumber)*@
                                        </th>
                                        <th>
                                            Cubic
                                            @*@Html.DisplayNameFor(model => model.Volume)*@
                                        </th>
                                        <th>
                                            Ctn Size
                                            @*@Html.DisplayNameFor(model => model.BoxSize)*@
                                        </th>
                                        <th>
                                            Created
                                            @*@Html.DisplayNameFor(model => model.EstimatedShippingDate)*@
                                        </th>
                                        <th style="visibility:hidden"></th>
                                        <th style="visibility:hidden"></th>
                                        <th style="visibility:hidden"></th>
                                        <th>Notes</th>
                                        <th>Conf #</th>
                                        <th style="visibility:hidden"></th>
                                        <th style="visibility:hidden"></th>
                                        <th style="visibility:hidden"></th>
                                        <th style="visibility:hidden"></th>
                                        <th style="visibility:hidden"></th>
                                        <th>Shipping</th>

                                    </tr>
                                </thead>

                                <tbody>
                                    @foreach (var item in Model.OrderAppointments)
            {
                                        <tr class="info">
                                            <td></td>
                                            <td>
                                                @Html.DisplayFor(modelItem => item.StoreName)
                                            </td>
                                            <td>
                                                @Html.DisplayFor(modelItem => item.StartDate)
                                            </td>
                                            <td>
                                                @Html.DisplayFor(modelItem => item.EndDate)
                                            </td>
                                            <td>
                                                @Html.DisplayFor(modelItem => item.PurchaseOrderId)
                                            </td>
                                            <td>
                                                @Html.DisplayFor(modelItem => item.PickTicketId)
                                            </td>
                                            <td>
                                                @Html.DisplayFor(modelItem => item.Pieces)
                                            </td>
                                            <td>
                                                @Html.DisplayFor(modelItem => item.Weight)
                                            </td>
                                            <td>
                                                @Html.DisplayFor(modelItem => item.BoxesNumber)
                                            </td>
                                            <td>
                                                @Html.DisplayFor(modelItem => item.Volume)
                                            </td>
                                            <td>
                                                @Html.DisplayFor(modelItem => item.BoxSize)
                                            </td>
                                            <td>
                                                @Html.DisplayFor(modelItem => item.EstimatedShippingDate)
                                            </td>
                                            <td style="visibility:hidden">
                                                @Html.DisplayFor(modelItem => item.PtBulk)
                                            </td>
                                            <td style="visibility:hidden">
                                                @Html.DisplayFor(modelItem => item.CustomerId)
                                            </td>
                                            <td style="visibility:hidden">
                                                @Html.DisplayFor(modelItem => item.DivisionName)
                                            </td>
                                            <td>
                                                @Html.DisplayFor(modelItem => item.Notes)
                                            </td>
                                            <td>
                                                @Html.DisplayFor(modelItem => item.ConfirmationNumber)
                                            </td>
                                            <td style="visibility:hidden">
                                                @Html.DisplayFor(modelItem => item.DivisionId)
                                            </td>
                                            <td style="visibility:hidden">
                                                @Html.DisplayFor(modelItem => item.BillOfLading)
                                            </td>
                                            <td style="visibility:hidden">
                                                @Html.DisplayFor(modelItem => item.DeliveryTypeId)
                                            </td>
                                            <td style="visibility:hidden">
                                                @Html.DisplayFor(modelItem => item.ScacCode)
                                            </td>
                                            <td style="visibility:hidden">
                                                @Html.DisplayFor(modelItem => item.ShipFor)
                                            </td>
                                            <td>
                                                @Html.DisplayFor(modelItem => item.Shipping)
                                            </td>
                                        </tr>
                                    }
                                </tbody>

                            </table>
                        </div>
                    </div>
>                    
                </div>
            </div>

        </div>
    </div>
    <div id="appointments" class="tab-pane fade">
        @*<h2>Appointments</h2>*@
        <div class="row">
            <div class="panel panel-default">
                <div class="panel-heading">
                </div>
                @using (Ajax.BeginForm("GetAppointments", ajaxOptions))
                {

                    <div class="btn-group btn-group-justified">
                        @if (User.IsInRole("Administrators"))
                        {
                            <a href="#" class="btn btn-info" onclick="postAppointment()">Post Appointments</a>
                            <a href="#" class="btn btn-info" onclick="deleteAppointment()">Cancel Appointments</a>
                            <a href="#" class="btn btn-info" onclick="editAppointment()">Edit Appointments</a>
                        }
                        <a href="@Url.Action("LogReport", "OrderAppointment")" class="btn btn-info">Log Report</a>
                        <a href="#" class="btn btn-info" id="btnRefreshAppt">Refresh</a>

                    </div>
                        <div class="panel panel-default">
                            <div class="panel-heading">Search</div>
                            <div class="panel-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            @Html.LabelFor(model => model.SelectedStatus)
                                            @Html.DropDownListFor(x => x.SelectedStatus, appointmentStatus, "Select", new { @class = "form-control" })
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            @Html.LabelFor(model => model.AppointmentNumberSearch)
                                            @Html.TextBoxFor(x => x.AppointmentNumberSearch, new { @class = "form-control" })
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            @Html.LabelFor(model => model.ShippingDateStart)
                                            @Html.DatePicker(x => x.ShippingDateStart,-2, new { @class = "form-control" })
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            @Html.LabelFor(model => model.ShippingDateEnd)
                                            @Html.DatePicker(x => x.ShippingDateEnd,0, new { @class = "form-control" })
                                        </div>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                }
                <div class="panel-body" id="panelBody">
                    <div id="loading" class="load" style="display:none">
                        <p>Loading Data...</p>
                    </div>

                    @*@{ Html.RenderPartial("_AppointmentList", Model.Appointments); }*@
                    @Html.Action("GetAppointments", Model)
                </div>
            </div>
        </div>

    </div>
</div>

<div class="modal fade" id="setConfirmationNumberModal" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dissmiss="modal" aria-hidden="true"></button>
                <h3 class="modal-title">Set Confirmation Number</h3>
                <h4 class="pull-right"><span id="totalOrdersSelectedLabel"></span></h4>
            </div>
            <div class="modal-body">
                <form role="form" class="validate">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                @Html.LabelFor(m => m.ConfirmationNumber)
                                @Html.TextBoxFor(m => m.ConfirmationNumber, new { @class = "form-control" })
                                @Html.ValidationMessageFor(m => m.ConfirmationNumber)
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">Close</button>
                <button type="button" id="btnSaveConfNumber" onclick="setNewConfirmationNumber()" class="btn btn-info">Save</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="setAppointmentModal" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dissmiss="modal" aria-hidden="true"></button>
                <h3 class="modal-title">Set appointment</h3>
                <h4 class="pull-left"><span id="totalOrdersLabel"></span></h4>

            </div>
            <div class="modal-body">
                <form role="form" class="validate">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                @Html.LabelFor(m => m.DeliveryTypeId)
                                <div class="radio-inline">
                                    @Html.RadioButtonFor(m => m.DeliveryTypeId, 1, new { id = "IsPickup" })
                                    <span style="padding-right:20px">Pickup</span>
                                    @Html.RadioButtonFor(m => m.DeliveryTypeId, 2, new { id = "IsDelivery" })
                                    <span>Delivery</span>
                                    @Html.ValidationMessageFor(m => m.DeliveryTypeId)
                                </div>
                            </div>
                            <div class="form-group">
                                @Html.LabelFor(m => m.AppointmentNumber)
                                @Html.TextBoxFor(m => m.AppointmentNumber, new { @class = "form-control" })
                                @Html.ValidationMessageFor(m => m.AppointmentNumber)
                            </div>
                            <div class="form-group">
                                @Html.LabelFor(m => m.ShippingDate)
                                @Html.DatePicker(m => m.ShippingDate, minDateDays: -2, htmlAttributes:  new { @class = "form-control" })
                                @Html.ValidationMessageFor(m => m.ShippingDate)
                            </div>
                            <div class="form-group">
                                @Html.LabelFor(m => m.ShippingTime)
                                @Html.DateTimePicker(model => model.ShippingTime, null, jsFormat: "hh:ii p", cFormat: "LT", todayHighlight: false, minView: DateTimePickerView.Hour, startView: DateTimePickerView.Day)
                                @Html.ValidationMessageFor(m => m.ShippingTime)
                            </div>
                            <div class="form-group">
                                @Html.LabelFor(m => m.ShippingTimeLimit)
                                @Html.DateTimePicker(model => model.ShippingTimeLimit, null, jsFormat: "hh:ii p", cFormat: "LT", todayHighlight: false, minView: DateTimePickerView.Hour, startView: DateTimePickerView.Day)
                            </div>
                            <div class="form-group">
                                @Html.LabelFor(model => model.ShippingCompanyId)
                                @Html.DropDownListFor(m => m.ShippingCompanyId, scacCodes, null, new { @class = "form-control" })
                                @Html.ValidationMessageFor(m => m.ShippingCompanyId)
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <ul class="list-group" id="summary">
                    <li class="list-group-item"><span class="badge" id="totPcs"></span>Total Pieces:&nbsp;</li>
                    <li class="list-group-item"><span class="badge" id="totalCtns"></span>Total Ctns:&nbsp;</li>
                    <li class="list-group-item"><span class="badge" id="totalLbs"></span>Total Weight:&nbsp;</li>
                    <li class="list-group-item"><span class="badge" id="totalCubic"></span>Total Cubic:&nbsp;</li>
                    <li class="list-group-item"><span class="badge" id="totalgohs"></span>Total GOH's:&nbsp;</li>


                </ul>
                <button type="button" class="btn btn-white" data-dismiss="modal">Close</button>
                <button type="button" id="btnSave" onclick="setNewAppointment()" class="btn btn-info">Set Appointment</button>
            </div>
        </div>
    </div>
</div>


@Scripts.Render("~/bundles/datetimepicker")
@Scripts.Render("~/bundles/dataTables")
@Scripts.Render("~/bundles/jqueryval")
<script src="~/Scripts/DataTables/dataTables.select.min.js"></script>

<script type="text/javascript">

    var editor;
    $(document).ready(function () {
        (function (seconds) {
            var refresh,
                intvrefresh = function () {
                    clearInterval(refresh);
                    refresh = setTimeout(function () {
                        // location.href = location.href;
                        window.location.reload(1);
                    }, seconds * 1000);
                };

            $(document).on('keypress click', function () { intvrefresh() });
            intvrefresh();

        }(300));

        $("#selectedPanel").hide();
        $("#ShippingCompanyId").select2();
        $("#SelectedClientId").select2();
        $("#SelectedDivisionId").select2();
       // $("#ShipFor").attr('disabled', 'disabled');

        $(".select2-container").width(300);

        //var tableSelectedOrders = $("tableSelectedOrders").DataTable({
        //});

        $("#tableSelectedOrders").DataTable({
            dom: 'Bfrtip',
            responsive: true,
            columns: [
                {
                    data: 'ShipTo'
                }
                ,
                {
                    data: 'StartDate'
                }
                ,
                {
                    data: 'EndDate'
                }
                ,
                {
                    data: 'PurchaseOrderId'
                }
                ,
                {
                    data: 'PickTicketId'
                }
                ,
                {
                    data: 'Pieces'
                }
                ,
                {
                    data: 'Weigth'
                }
                ,
                {
                    data: 'BoxesCount'
                }
                ,
                {
                    data : 'Size'
                }
                ,
                {
                    data: 'BoxSize'
                }
                ,
                {
                    data: 'BillOfLading', visible:false
                }
                ,
                {
                    data: 'DeliveryTypeId', visible:false
                }
                ,
                {
                    data: 'ScacCode', visible:false
                }
                ,
                {
                    data: 'ShipFor', visible:false
                }
            ]
            
        });

        $("#tableAppointments").DataTable({
            dom: 'Bfrtip',
            responsive: true,
            "displayLength": 15,
            columnDefs: [{
                orderable: false,
                className: 'select-checkbox',
                targets: 0
            }],
            columns: [
                {
                    orderable: false
                },
                {
                    data: 'StoreName'
                }
                ,
                {

                }
                ,
                {

                }
                ,
                {
                    data: 'PurchaseOrderId'
                }
                ,
                {
                    data: 'PickTicketId'
                }
                ,
                {

                }
                ,
                {

                }
                ,
                {

                }
                ,
                {

                }
                ,
                {

                }
                ,
                {

                }
                ,
                {
                    visible: false
                }
                ,
                {
                    visible: false
                }
                ,
                {
                    visible: false
                }
                ,
                {
                    data: 'Notes', className: 'editable'
                }
                ,
                {
                    data: 'ConfirmationNumber'
                }
                ,
                {
                    data: 'DivisionId', visible :false
                }
                ,
                {
                    data: 'BillOfLading', visible: false
                }
                ,
                {
                    data : 'DeliveryTypeId', visible: false
                }
                ,
                {
                    data : 'ScacCode', visible: false
                }
                ,
                {
                    data : 'ShipFor', visible: false
                }
                ,
                {
                    data : 'Shipping'
                }




                ]
                ,
                select: {
                    style: 'multi',
                },
                "drawCallback": function (settings) {
                    var api = this.api();
                    var rows = api.rows({ page: 'current' }).nodes();
                    var last = null;

                    api.column(14, { page: 'current' }).data().each(function (group, i) {
                        val = api.row(api.row($(rows).eq(i)).index()).data();
                        var client = val[13];
                        if (last !== group) {
                            api.column
                            $(rows).eq(i).before(
                                '<tr class="group"><td colspan="15">' + client + ' - ' + group + '</td></tr>'
                            );

                            last = group;
                        }

                    });
                },
                "createdRow": function (row, data, dataIndex) {
                    if (data['ConfirmationNumber'].length > 0) {
                        $(row).css("background-color", "#EBE566");
                    }
                }

        });

        //var tableorders = $("#tableAppointments").DataTable();

        //tableorders.on('select', function (e, dt, type, indexes) {
        //    var row = tableorders.row($(this).parents('tr'));
        //    var rowNode = dt.node();
        //   // row.remove();

        //    tableSelectedOrders
        //        .row.add(rowNode)
        //        .draw();
        //});

            $('#tableAppointments tfoot th').each(function () {

                var title = $(this).text();
                if (title == "PO#" || title == "PT#") {


                    $(this).html('<input type="text" style="width:80px" placeholder="Search ' + title + '" />');
                }
            });
            $('#tableAppointments tbody').on('click', 'tr.group', function () {
                var currentOrder = table.order()[0];
                if (currentOrder[0] === 2 && currentOrder[1] === 'asc') {
                    table.order([14, 'desc']).draw();
                }
                else {
                    table.order([14, 'asc']).draw();
                }
            });


            // DataTable
            var table = $("#tableAppointments").DataTable();

            // Apply the search
            table.columns().every(function () {
                var that = this;

                $('input', this.footer()).on('keyup change', function () {
                    if (that.search() !== this.value) {
                        that
                            .search(this.value)
                            .draw();
                        var str = this.placeholder;
                        if (str.includes("PT#")) {
                            console.log('search by pt');
                            if (table.page.info().recordsDisplay == 0) {
                                $.ajax({
                                    type: "GET",
                                    url: '@Url.Action("SearchPickTicket", "OrderAppointment")',
                                    contentType: "application/json; charset=utf-8",
                                    data: { "pickTicketId": this.value },
                                    success: function (result) {
                                        if (result.result == "NotFound") {
                                            toastr.options = {
                                                "closeButton": true,
                                                "positionClass": "toast-bottom-full-width",
                                                "preventDuplicates": true
                                            };
                                            toastr.warning("Pick Ticket # " + result.pickTicketId + " has not been transferred to the database");
                                        }
                                        else {
                                            var dateString = result.shippingDate.substr(6);
                                            var currentTime = new Date(parseInt(dateString));
                                            var month = currentTime.getMonth() + 1;
                                            var day = currentTime.getDate();
                                            var year = currentTime.getFullYear();
                                            var date = month + "/" + day + "/" + year;
                                            var msg = "Pick Ticket has been set for ";
                                            msg = msg + "</br>" + " Appointment #: " + result.appointmentNumber;
                                            msg = msg + "</br>" + " Carrier: " + result.carrier;
                                            msg = msg + "</br>" + " Shipping Date: " + date;
                                            toastr.info(msg, "Pick Ticket found", {
                                                "closeButton": true, "positionClass": "toast-bottom-full-width", "preventDuplicates": true, "showDuration": "300",
                                                "hideDuration": "1000",
                                                "timeOut": "25000"
                                            });
                                        }
                                    }
                                });
                            }

                        }
                        if (str.includes("PO#")) {
                            console.log('search by po');
                            if (table.page.info().recordsDisplay == 0) {
                                $.ajax({
                                    type: "GET",
                                    url: '@Url.Action("SearchPurchaseOrder", "OrderAppointment")',
                                    contentType: "application/json; charset=utf-8",
                                    data: { "purchaseOrder": this.value },
                                    success: function (result) {
                                        if (result.result == "NotFound") {
                                            toastr.options = {
                                                "closeButton": true,
                                                "positionClass": "toast-bottom-full-width",
                                                "preventDuplicates": true
                                            };
                                            toastr.warning("PO # " + result.purchaseOrder + " has not been transferred to the database");
                                        }
                                        else {
                                            var dateString = result.shippingDate.substr(6);
                                            var currentTime = new Date(parseInt(dateString));
                                            var month = currentTime.getMonth() + 1;
                                            var day = currentTime.getDate();
                                            var year = currentTime.getFullYear();
                                            var date = month + "/" + day + "/" + year;
                                            var msg = "Purchase Order has been set for ";
                                            msg = msg + "</br>" + " Appointment #: " + result.appointmentNumber;
                                            msg = msg + "</br>" + " Carrier: " + result.carrier;
                                            msg = msg + "</br>" + " Shipping Date: " + date;
                                            toastr.info(msg, "Purchase Order found", {
                                                "closeButton": true, "positionClass": "toast-bottom-full-width", "preventDuplicates": true, "showDuration": "300",
                                                "hideDuration": "1000",
                                                "timeOut": "25000"
                                            });
                                        }
                                    }
                                });
                            }

                        }

                    }
                });
            });
            //table.on('search.dt', function () {
            //    console.log(table.page.info());
            //});

        $('#tableAppointments tbody tr').on('click', function (e) {
            var $row = $(this);

            if ($row.hasClass('selected')) {
                $row.removeClass('selected');
                e.stopPropagation();
                var existingRow = table
                    .rows(function (idx, info, node) {
                        return info["PurchaseOrderId"] == $row[0].cells[4].innerText && info["PickTicketId"] == $row[0].cells[5].innerText  ?
                        true : false;
                    });
                if (existingRow != null) {
                    console.log('true');
                    table.rows(existingRow).deselect();
                }

            } else {
                $row.addClass('selected');
            }

        });


            var tableSelected = $("#tableSelectedOrders").DataTable();

            table.on('select', function (e, dt, type, indexes) {
                if (type == "row") {
                   $("#selectedPanel").show(100);
                   var data = table.rows(indexes).data();
                   if (table.rows(indexes).nodes().to$().hasClass('selected') == false) {
                   //   // table.rows(indexes).nodes().to$().removeClass('selected');
                       return false;
                   }
                   console.log(table.rows(indexes).nodes().to$().hasClass('selected'));
                    //tableSelected.row.add({
                    //    "ShipTo": data[0]["StoreName"],
                    //    "StartDate":data[0][2],
                    //    "EndDate":data[0][3],
                    //    "PurchaseOrderId": data[0]["PurchaseOrderId"],
                    //    "PickTicketId": data[0]["PickTicketId"],
                    //    "Pieces": data[0][6],
                    //    "Weigth": data[0][7],
                    //    "BoxesCount": data[0][8],
                    //    "Size": data[0][9],
                    //    "BoxSize": data[0][10],
                    //    "BillOfLading": data[0]["BillOfLading"],
                    //    "DeliveryTypeId": data[0]["DeliveryTypeId"],
                    //    "ScacCode": data[0]["ScacCode"]
                    //}).draw(false);

                        var count = 0;
                        $.ajax({
                            type: "GET",
                            url: '@Url.Action("SearchByBol", "OrderAppointment")',
                            contentType: "application/json; charset=utf-8",
                            data: { "bol": data[0]["BillOfLading"] },
                            success: function (result) {

                                 
                                if (result.result == "Success" ) {
                                    var orders = result.orders;
                                    if (orders != null) {

                                        count = orders.length;
                                    }
                                    for (var i = 0; i < orders.length; i++) {
                                        //if (orders[i]["PurchaseOrderId"] != data[0]["PurchaseOrderId"]) {
                                            tableSelected.row.add({
                                                "ShipTo": orders[i].ShipTo,
                                                "StartDate": ToDate(orders[i].StartDate),
                                                "EndDate": ToDate(orders[i].EndDate),
                                                "PurchaseOrderId": orders[i].PurchaseOrderId,
                                                "PickTicketId": orders[i].PickTicketId,
                                                "Pieces": orders[i].Pieces,
                                                "Weigth": orders[i].Weigth,
                                                "BoxesCount": orders[i].BoxesCount,
                                                "Size": orders[i].Size,
                                                "BoxSize": orders[i].BoxSize,
                                                "BillOfLading": orders[i].BillOfLading,
                                                "DeliveryTypeId": orders[i].DeliveryTypeId,
                                                "ScacCode": orders[i].ScacCode,
                                                "ShipFor": ToDate(orders[i].ShipFor)

                                                }).draw(false);
                                            var existingRow = table
                                                .rows(function (idx, info, node) {
                                                    return  info["PurchaseOrderId"] == orders[i].PurchaseOrderId && info["PickTicketId"] == orders[i].PickTicketId ?
                                                    true : false;
                                                });

                                            if (existingRow) {
                                                table.row(existingRow).nodes().to$().addClass('selected');
                                            }
                                        //}
                                    }
                                }
                                else {
                                    tableSelected.row.add({
                                        "ShipTo": data[0]["StoreName"],
                                        "StartDate":data[0][2],
                                        "EndDate":data[0][3],
                                        "PurchaseOrderId": data[0]["PurchaseOrderId"],
                                        "PickTicketId": data[0]["PickTicketId"],
                                        "Pieces": data[0][6],
                                        "Weigth": data[0][7],
                                        "BoxesCount": data[0][8],
                                        "Size": data[0][9],
                                        "BoxSize": data[0][10],
                                        "BillOfLading": data[0]["BillOfLading"],
                                        "DeliveryTypeId": data[0]["DeliveryTypeId"],
                                        "ScacCode": data[0]["ScacCode"],
                                        "ShipFor": ToDate(data[0]["ShipFor"])
                                    }).draw(false);
            
                                }
                                if (count > 1) {
                                    toastr.info(count + " orders were found associated to Bill of Lading '" + data[0]["BillOfLading"] + "', and they are being added automatically for appointment", "Order associated to BOL", {
                                        "closeButton": true, "positionClass": "toast-top-center", "preventDuplicates": true, "showDuration": "300",
                                        "hideDuration": "1000",
                                        "timeOut": "25000"
                                    });
                                   
                                }
                            }
                        });

                }
            });
            table.on('deselect', function (e, dt, type, indexes) {
                if (type === 'row') {
                    var unselected = table.rows(indexes).data();

                    var existingRow = tableSelected
                            .rows(function (idx, data, node) {
                                return  data["PurchaseOrderId"] == unselected[0]["PurchaseOrderId"] && data["PickTicketId"] == unselected[0]["PickTicketId"] ?
                                true : false;
                            });
                    if (existingRow) {
                        tableSelected.row(existingRow).remove().draw();
                        if (tableSelected.data().count() == 0) {
                            $("#selectedPanel").hide(500);
                        }

                    }


                }
            });

            function myCallbackFunction(updatedCell, updatedRow, oldValue) {
                console.log("The new value for the cell is: " + updatedCell.data());
                console.log("The values for each cell in that row are: " + updatedRow.data());



                var model = {
                    PurchaseOrderId: updatedRow.data()["PurchaseOrderId"],
                    PickTicketId: updatedRow.data()["PickTicketId"],
                    PtBulk: updatedRow.data()[12],
                    CustomerId: updatedRow.data()[13],
                    Notes: updatedCell.data()
                };

                $.ajax({
                    type: "POST",
                    url: '@Url.Action("UpdateOrderAppointment", "OrderAppointment")',
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify(model),
                    dataType: "json",
                    success: function (result) {
                        toastr.success('Notes updated!')
                        //window.location.href = result.url;
                    }
                });

            }

            table.MakeCellsEditable({
                "onUpdate": myCallbackFunction,
                "columns": [15],
                "confirmationButton" : true,
                "inputTypes": [
                    {
                        "column":0,
                        "type":"text",
                        "options":null
                    }]

            });

            $('.datetimepicker-minutes .switch').attr('style', 'visibility:hidden;');
            $('.datetimepicker-hours .switch').attr('style', 'visibility:hidden;');


            $("#btnRefresh").click(function () {
                $(this).closest("form").submit();
            });
            $("#btnRefreshAppt").click(function () {
                $(this).closest("form").submit();
                $("#appointments").tab('show');

            });


            $('#chkShipForSearch').change(function () {
                if ($('#chkShipForSearch').prop('checked') == true) {
                    $('#ShipFor').removeAttr('disabled');
                    $('#CancelDateStartDate').attr('disabled', 'disabled');
                    $('#CancelDateEndDate').attr('disabled', 'disabled');

                } else {
                    $('#ShipFor').attr('disabled', 'disabled');
                    $('#CancelDateStartDate').removeAttr('disabled');
                    $('#CancelDateEndDate').removeAttr('disabled');
                }


            });


            $("#SelectedClientId").change(function () {
                var selectedItem = $(this).val();
                var ddDivisions = $("#SelectedDivisionId");
                $.ajax({
                    cache: false,
                    type: 'GET',
                    url: '@Url.Action("GetDivisionByClient","OrderAppointment")',
                    data: { "customerId": selectedItem },
                    success: function (data) {
                        ddDivisions.html('');
                        $.each(data, function (id, option) {
                            ddDivisions.append($('<option></option>').val(option.Id).html(option.Name));

                        });


                    }
                    , error: function (xhr, ajaxOptions, thrownError) {
                        toastr.error('Failed to get Divisions');
                    }
                });


            });

    });

    function editAppointment() {
        var table = $("#tableappt").DataTable();
        var selected = table.rows('.selected').data();
        if (selected.length == 0) {
            toastr.warning("Please select at least an Order");
            return false;
        }
        var appts = new Array();



        for (var i = 0; i < selected.length; i++) {
            appts.push(selected[i]["AppointmentNo"]);

        }

        var allSameAppointmentNumber = appts.allValuesSame();

        if (allSameAppointmentNumber == false){
            toastr.warning("Please ensure all the Appointments are grouped on the same appointment number");
        }
        else {
            $('#setAppointmentModal').modal({
                show: true,
                backdrop: "static"
            });
            $("#AppointmentNumber").val(selected[0]["AppointmentNo"]);
            $("#ShippingDate").val(selected[0]["ShipDate"]);
            $("#ShippingTime").val(selected[0]["ShipTime"]);
            $("#ShippingCompanyId").val(selected[0]["ScaccCode"]).change();

            var dt = selected[0]["DeliveryTypeId"];
            if (dt == "1") {
                $("#IsPickup").prop("checked", true);
            }
            else if (dt == "2") {
                $("#IsDelivery").prop("checked", true);
            }

            $("#summary").hide();

            $('#btnSave').html("Save");
            $('#btnSave').attr('onclick', 'saveEditedAppointments()')
            $('#setAppointmentModal form').validate();
        }


    }

    function saveEditedAppointments() {
        var table = $("#tableappt").DataTable();
        if ($('#setAppointmentModal form').valid()) {
            var selected  = table.rows('.selected').data();
            var orders = new Array();

            for (var i = 0; i < selected.length; i++) {

                var orderWithAppointment = {
                    PurchaseOrderId: selected[i]["PurchaseOrder"],
                    PickTicketId: selected[i]["PickTicket"],
                    CustomerId: selected[i]["CustomerId"],
                    DateAdded: selected[i]["DateAdded"]
                };
                orders.push(orderWithAppointment);
            }

            var model = {};
            model.AppointmentNumber = $("#AppointmentNumber").val();
            model.Shippingdate = $("#ShippingDate").val();
            model.ShippingTime = $("#ShippingTime").val();
            model.ScacCode = $("#ShippingCompanyId").val();
            model.ShippingTimeLimit = $('#ShippingTimeLimit').val();
            model.DeliveryTypeId = $('input[name = DeliveryTypeId]:checked').val();

            model.Orders = orders;

            $.ajax({
                type: "POST",
                url: '@Url.Action("SaveEditedAppointment", "OrderAppointment")',
                contentType: "application/json; charset=utf-8",
                data:  JSON.stringify(model),
                dataType: "json",
                success: function (result) {
                    toastr.success('Appointment set successfully');
                    $("#btnRefreshAppt").trigger("click");
                    //window.location.href = "GetAppointments";
                }
            });
            $('#setAppointmentModal').modal("hide");


        }
    }

    Array.prototype.allValuesSame = function () {
        for (var i = 1; i < this.length; i++) {
            if (this[i] !== this[0])
                return false;
        }

        return true;
    };

    function showConfirmationNumberModal() {
        var table = $("#tableAppointments").DataTable();
        var selected = table.rows('.selected').data();
        if (selected.length == 0) {
            toastr.warning("Please select at least an Order");

            return false;
        }
        $('#totalOrdersSelectedLabel').html(function (n, c) {
            return selected.length + ' selected order(s)'
        });
        $('#setConfirmationNumberModal').modal({
            show: true,
            backdrop: "static"
        });

        $('#setConfirmationNumberModal form').validate();
    }

    function setNewConfirmationNumber() {
        var table = $("#tableAppointments").DataTable();
        if ($('#setConfirmationNumberModal form').valid()) {

            var selected = table.rows('.selected').data();

            var orders = new Array();
            for (var i = 0; i < selected.length; i++) {

                var orderForAppointment = {
                    PurchaseOrderId: selected[i]["PurchaseOrderId"],
                    PickTicketId: selected[i]["PickTicketId"],
                    PtBulk: selected[i][12],
                    CustomerId: selected[i][13]
                };
                orders.push(orderForAppointment);

            }
            var model = {};
            model.ConfirmationNumber = $("#ConfirmationNumber").val();
            model.Orders = orders;

            $.ajax({
                type: "POST",
                url: '@Url.Action("SetConfirmationNumber", "OrderAppointment")',
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(model),
                dataType: "json",
                success: function (result) {
                    toastr.success('Confirmation Number set successfully');
                    $("#btnRefresh").trigger("click");
                   // window.location.href = "List";
                }
            });
            $('#setAppointmentModal').modal("hide");
            $("#ConfirmationNumber").val('');
        }
    }

    function setAppointment() {
        clearAppointmentForm();
        var table = $("#tableAppointments").DataTable();
        
        var t2 = $("#tableSelectedOrders").DataTable();
        var selected = table.rows('.selected').data();
        var selected2 = t2.rows().data();
        if (selected.length == 0) {
            toastr.warning("Please select at least an Order");
            return false;
        }
        $('#totalOrdersLabel').html(function(n, c) {
            return selected.length + ' order(s) to assign'
        });
        var totalPieces = 0;
        var totalCtns = 0;
        var totalLbs = 0;
        var totalCubic = 0;
        var gohs = 0;
        var hasBol = false;
        for (var i = 0; i < selected2.length; i++) {

            totalPieces += Number(selected2[i]["Pieces"]);
            totalLbs += Number(selected2[i]["Weigth"]);
            totalCtns += Number(selected2[i]["BoxesCount"]);
            totalCubic += Number(selected2[i]["Size"]);
            if (selected2[i]["BoxSize"] == "GOH") {
                gohs += Number(selected2[i]["Pieces"]);
            }

            if (selected2[i]["BillOfLading"].length > 0){
                hasBol = true;
            }


        }
        $('#totPcs').html(function (n, c) {
            return totalPieces;
        });
        $('#totalCtns').html(function (n, c) {
            return totalCtns ;
        });
        $('#totalCubic').html(function (n, c) {
            return totalCubic;
        });
        $('#totalLbs').html(function (n, c) {
            return totalLbs ;
        });
        if (gohs > 0) {
            $('#totalgohs').html(function (n, c) {
                return gohs;
            });
        }
        else {
            $('#summary li:last').remove();
           
        }

        if (hasBol == true) {
            $("#ShippingCompanyId").val(selected2[0]["ScacCode"]).change();
            $("#ShippingCompanyId").prop('disabled', true)
            var dt = selected2[0]["DeliveryTypeId"];
            if (dt == "1") {
                $("#IsPickup").prop("checked", true);
            }
            else if (dt == "2") {
                $("#IsDelivery").prop("checked", true);
            }
            $('input[name = DeliveryTypeId]').attr('disabled', 'disabled');

            $("#ShippingDate").val(selected2[0]["ShipFor"]);
        }


        $('#setAppointmentModal form').validate();

        $('#setAppointmentModal').modal({
            show: true,
            backdrop: "static"
        });



    }

    function clearAppointmentForm() {
        $('#ShippingDate').val('');
        $('#ShippingTime').val('');
        $("#ShippingCompanyId")[0].selectedIndex = 0;
        $("#AppointmentNumber").val('');
        $("#ShippingTimeLimit").val('');
        $("#ShippingCompanyId").val('').trigger('change');
        $('input[name = DeliveryTypeId]').attr('checked', false);

        $('input[name = DeliveryTypeId]').removeAttr('disabled');

        $("#ShippingCompanyId").prop('disabled', false)

    }


        function setNewAppointment() {
            var table = $("#tableAppointments").DataTable();


            if ($('#setAppointmentModal form').valid()) {

                var selected  = table.rows('.selected').data();

                var orders = new Array();



                for (var i = 0; i < selected.length; i++) {

                    var orderForAppointment = {
                        PurchaseOrderId: selected[i]["PurchaseOrderId"],
                        PickTicketId: selected[i]["PickTicketId"],
                        PtBulk: selected[i][12],
                        CustomerId: selected[i][13],
                        DivisionId: selected[i]["DivisionId"]
                    };
                    orders.push(orderForAppointment);
                }

                var model = {};
                model.AppointmentNumber = $("#AppointmentNumber").val();
                model.Shippingdate = $("#ShippingDate").val();
                model.ShippingTime = $("#ShippingTime").val();
                model.ScacCode = $("#ShippingCompanyId").val();
                model.ShippingTimeLimit = $('#ShippingTimeLimit').val();
                model.DeliveryTypeId = $('input[name = DeliveryTypeId]:checked').val();

                model.Orders = orders;

                $.ajax({
                    type: "POST",
                    url: '@Url.Action("SetAppointment", "OrderAppointment")',
                    contentType: "application/json; charset=utf-8",
                    data:  JSON.stringify(model),
                    dataType: "json",
                    success: function (result) {
                        toastr.info('Appointment set successfully');
                        $("#btnRefresh").trigger("click");
                        //window.location.href = "List";
                    },
                    error: function (result) {
                        toastr.error('something went wrong');
                    }
                });
                $('#setAppointmentModal').modal("hide");

            }
        }

        function postAppointment() {
            var table = $("#tableappt").DataTable();
            var selected = table.rows('.selected').data();
            if (selected.length == 0) {
                toastr.warning("Please select at least one Appointment");
                return false;
            }
            var apptNos = new Array();
            var bols = new Array();
            var carriers = new Array();

            for (var i = 0; i < selected.length; i++) {
                apptNos.push(selected[i]["AppointmentNo"]);
                bols.push(selected[i]["BillOfLading"]);
                carriers.push(selected[i]["Carrier"])
            }

            if (bols.length > 0) {
                var allSameBol = bols.allValuesSame();
            }
            if (apptNos.length > 0) {
                var allSameApptNo = apptNos.allValuesSame();
            }
            if (carriers.length > 0) {
                var allSameCarriers = carriers.allValuesSame();
            }
            
            if (allSameCarriers == false) {
                toastr.error("Please ensure all the Orders tied to the same carrier ","Please review!", {
                        "closeButton": true, "timeOut": "8000"
                        });
                        return false;
            }

            //if (allSameBol == false || apptNos == false) {
            //    toastr.error("Please ensure all the Orders have same Bill of Lading Number and/or Appointment Number ","Please review!", {
            //    "closeButton": true, "timeOut": "8000"
            //    });
            //    return false;
            //}
            

            if (confirm('Are you sure you want to post these ' + selected.length + ' selected appointments ?')) {
                var selected = table.rows('.selected').data();

                var appointments = new Array();



                for (var i = 0; i < selected.length; i++) {

                    var appointment = {
                        CustomerId: selected[i]["CustomerId"],
                        PickTicket: selected[i]["PickTicket"],
                        AppointmentNo: selected[i]["AppointmentNo"],
                        Posted: true
                    };
                    appointments.push(appointment);
                }

                var model = {};
                model.Action = 1;
                model.Appointments = appointments;

                $.ajax({
                    type: "POST",
                    url: '@Url.Action("ActionAppointments", "OrderAppointment")',
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify(model),
                    dataType: "json",
                    success: function (result) {
                        toastr.success('Appointment(s) posted successfully');
                        alert();
                        table.rows('.selected').remove().draw(false);
                    }

                });

            }

        }

    function deleteAppointment() {
        var table = $("#tableappt").DataTable();
        var selected = table.rows('.selected').data();
        if (selected.length == 0) {

            toastr.warning("Please select at least one Appointment");
            return false;
        }

        if (confirm('Are you sure you want to cancel these ' + selected.length + ' selected appointments ?')) {
            var selected = table.rows('.selected').data();

            var appointments = new Array();

            for (var i = 0; i < selected.length; i++) {

                var appointment = {
                    CustomerId: selected[i]["CustomerId"],
                    PickTicket: selected[i]["PickTicket"],
                    AppointmentNo: selected[i]["AppointmentNo"],
                    PurchaseOrderId: selected[i]["PurchaseOrder"],
                    Posted: false,
                    Status: "D"
                };
                appointments.push(appointment);
            }

            var model = {};
            model.Action = 2;
            model.Appointments = appointments;

            $.ajax({
                type: "POST",
                url: '@Url.Action("ActionAppointments", "OrderAppointment")',
                contentType: "application/json; charset=utf-8",
                data: JSON.stringify(model),
                dataType: "json",
                success: function (result) {

                    toastr.success('Appointment(s) cancelled successfully');
                    table.rows('.selected').remove().draw(false);
                }

            });

        }

    }

    $("#btnReport").click(function () {
        var model = getDataForReport();

        postReport(model);


    });


    function getDataForReport() {
        var model = {
            SelectedClientId: $("#SelectedClientId").val(),
            SelectedDivisionId: $("#SelectedDivisionId").val(),
            CancelDateStartDate: $("#CancelDateStartDate").val(),
            CancelDateEndDate: $("#CancelDateEndDate").val(),
            ShipFor: $('#ShipFor').val(),

        };

        return model;
    }

    function postReport(model) {
        toastr.info("Downloading Report...");
        $.ajax({
            type: "POST",
            url: '@Url.Action("GenerateOrdersReport", "OrderAppointment")',
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify(model),
            dataType: "json",

        }).done(function (returnValue) {
            if (returnValue.success) {
                window.location.href = "/OrderAppointment/DownloadReport?reportName=" + returnValue.fName + "&format=" + returnValue.mimeType + "&fileExtension=" + returnValue.ReportFormat;
                toastr.success("Report downloaded!");
            }
        }).fail(function () {
            toastr.error("Error downloading the report");
        });
    }

    function ToDate(date) {
        var dateString = date.substr(6);
        var currentTime = new Date(parseInt(dateString));
        var month = currentTime.getMonth() + 1;
        var day = currentTime.getDate();
        var year = currentTime.getFullYear();
        var date = month + "/" + day + "/" + year;

        return date;
    }
    



</script>

@Styles.Render("~/Content/datetimepicker")
@*@Styles.Render("~/Content/datatables")*@